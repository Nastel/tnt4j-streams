<?xml version="1.0" encoding="utf-8"?>
<!--
  ~ Copyright 2014-2022 JKOOL, LLC.
  ~
  ~ Licensed under the Apache License, Version 2.0 (the "License");
  ~ you may not use this file except in compliance with the License.
  ~ You may obtain a copy of the License at
  ~
  ~ http://www.apache.org/licenses/LICENSE-2.0
  ~
  ~ Unless required by applicable law or agreed to in writing, software
  ~ distributed under the License is distributed on an "AS IS" BASIS,
  ~ WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  ~ See the License for the specific language governing permissions and
  ~ limitations under the License.
  -->

<tnt-data-source
        xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
        xsi:noNamespaceSchemaLocation="https://raw.githubusercontent.com/Nastel/tnt4j-streams/master/config/tnt-data-source.xsd">

    <parser name="PropsParser" class="com.jkoolcloud.tnt4j.streams.parsers.ActivityNameValueParser">
        <property name="FieldDelim" value=","/>
        <property name="ValueDelim" value="="/>
        <!--<property name="EntryPattern"><![CDATA[(?<key>\w+)="(?<value>.*)"]]></property>-->

        <field name="EventType" value="NOOP"/>
        <field name="AllProps" locator="#" locator-type="Label" datatype="AsInput"/>
    </parser>

    <parser name="MetricLineParser" class="com.jkoolcloud.tnt4j.streams.parsers.ActivityRegExParser">
        <property name="Pattern"><![CDATA[^(?!\s*#)((?<key>\w+)(\{(?<props>.*)\})? (?<value>.+))]]></property>

        <field name="EventType" value="Snapshot"/>
        <field name="EventName" value="snapName">
            <field-transform lang="groovy"><![CDATA[
                String props = "";
                props += (StringUtils.isEmpty(${name1}) ? "" : "name1=" + ${name1});
                props += (props.length() > 0 ? "," : "") + "type1=" + ${type1};
                props += (StringUtils.isEmpty(${p4}) ? "" : (props.length() > 0 ? "," : "") + "p4=" + ${p4});
                props += (StringUtils.isEmpty(${p5}) ? "" : (props.length() > 0 ? "," : "") + "p5=" + ${p5});
                props += (StringUtils.isEmpty(${p6}) ? "" : (props.length() > 0 ? "," : "") + "p6=" + ${p6});
                props += (StringUtils.isEmpty(${p7}) ? "" : (props.length() > 0 ? "," : "") + "p7=" + ${p7});
                props += (StringUtils.isEmpty(${p8}) ? "" : (props.length() > 0 ? "," : "") + "p8=" + ${p8});

                ${domain} + ":" + props
            ]]></field-transform>
        </field>
        <field name="Severity" value="INFO"/>
        <field name="StartTime" locator="DateTime" locator-type="StreamProp" datatype="Timestamp"/>

        <field name="key" locator-type="Label" locator="key" transparent="true"/>
        <embedded-activity name="props" locator-type="Label" locator="props">
            <parser-ref name="PropsParser" aggregation="Merge"/>
        </embedded-activity>
        <field name="Value" locator-type="Label" locator="value"/>

        <field name="keyTokens" value="" datatype="AsInput" transparent="true">
            <field-transform lang="groovy"><![CDATA[
                ${key}.split("_")
            ]]></field-transform>
        </field>
        <field name="Category" locator="domain" locator-type="Activity"/>

        <field name="domain" value="metricDomain" transparent="true">
            <field-transform lang="groovy"><![CDATA[
                ${keyTokens}.length > 2
                    ? ${keyTokens}[0] + "." + ${keyTokens}[1]
                    : ${keyTokens}[0]
            ]]></field-transform>
        </field>
        <field name="type1" value="metricType" transparent="true">
            <field-transform lang="groovy"><![CDATA[
                ${keyTokens}.length > 2
                    ? ${keyTokens}[2]
                    : ${keyTokens}[1]
            ]]></field-transform>
        </field>
        <field name="name1" value="metricName" transparent="true">
            <field-transform lang="groovy"><![CDATA[
                ${keyTokens}.length > 3
                    ? ${keyTokens}[3]
                    : null
            ]]></field-transform>
        </field>
        <field name="p4" value="metricP4" transparent="true">
            <field-transform lang="groovy"><![CDATA[
                ${keyTokens}.length > 4
                    ? ${keyTokens}[4]
                    : null
            ]]></field-transform>
        </field>
        <field name="p5" value="metricP5" transparent="true">
            <field-transform lang="groovy"><![CDATA[
                ${keyTokens}.length > 5
                    ? ${keyTokens}[5]
                    : null
            ]]></field-transform>
        </field>
        <field name="p6" value="metricP6" transparent="true">
            <field-transform lang="groovy"><![CDATA[
                ${keyTokens}.length > 6
                    ? ${keyTokens}[6]
                    : null
            ]]></field-transform>
        </field>
        <field name="p7" value="metricP7" transparent="true">
            <field-transform lang="groovy"><![CDATA[
                ${keyTokens}.length > 7
                    ? ${keyTokens}[7]
                    : null
            ]]></field-transform>
        </field>
        <field name="p8" value="metricP8" transparent="true">
            <field-transform lang="groovy"><![CDATA[
                ${keyTokens}.length > 8
                    ? ${keyTokens}[8]
                    : null
            ]]></field-transform>
        </field>
    </parser>

    <parser name="MetricsParser" class="com.jkoolcloud.tnt4j.streams.parsers.ActivityStringParser">
        <property name="ActivityDelim" value="EOF"/>

        <field name="EventType" value="Activity"/>
        <field name="DataCenter" value="Amazon_MSK"/>
        <field name="ApplName" locator="$METADATA$.applId" locator-type="Label"/>
        <field name="BrokerId" locator="$METADATA$.brokerId" locator-type="Label"/>
        <field name="EventName" value="Amazon_MSK_Metrics"/>
        <field name="StartTime" locator="DateTime" locator-type="StreamProp" datatype="Timestamp"/>
        <field name="EndTime" locator="DateTime" locator-type="StreamProp" datatype="Timestamp"/>
        <embedded-activity name="MetricsData" locator="$DATA$" locator-type="Label">
            <field-transform lang="groovy"><![CDATA[
                String[] lines = $fieldValue.split("\\r|\\n");
                List<String> payloadLines = new ArrayList<>(lines.length);

                for (String line : lines) {
                    if (!StringUtils.startsWith (line, "#")) {
                        payloadLines.add(line);
                    }
                }

                return payloadLines;
            ]]></field-transform>
            <parser-ref name="MetricLineParser" aggregation="Relate"/>
        </embedded-activity>
    </parser>
</tnt-data-source>